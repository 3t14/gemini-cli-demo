name: Gemini AI Review

on:
  pull_request:
    types: [opened, synchronize, reopened]

jobs:
  gemini-review:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Run Gemini CLI
        id: gemini
        uses: google-github-actions/run-gemini-cli@v0
        with:
          gemini_api_key: ${{ secrets.GEMINI_API_KEY }}
          prompt: |
            You are a strict Python code reviewer.
            - Always respond with at least one finding or suggestion.
            - Identify bugs, missing error handling, and poor naming.
            - Provide concise markdown bullet points.
            - Respond in English.
      
      # --- Geminiã®å‡ºåŠ›ã‚’Summaryã«è¡¨ç¤º ---
      - name: Show Gemini output in summary
        run: |
          echo "### ğŸ§  Gemini Review Result" >> $GITHUB_STEP_SUMMARY
          cat gemini-artifacts/stdout.log >> $GITHUB_STEP_SUMMARY

      # --- PRã«è‡ªå‹•ã‚³ãƒ¡ãƒ³ãƒˆã‚’æŠ•ç¨¿ ---
      - name: Comment Gemini result on PR
        if: success()
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const body = fs.readFileSync('gemini-artifacts/stdout.log', 'utf8');
            if (body.trim().length === 0) {
              console.log("No Gemini output to comment.");
              return;
            }
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.payload.pull_request.number,
              body: `### ğŸ§  Gemini AI Review\n\n${body}`
            });
