name: Gemini AI Review (with diff)

on:
  pull_request:
    types: [opened, synchronize, reopened]

jobs:
  gemini-review:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      # --- Â∑ÆÂàÜ„ÇíÂèñÂæó„Åó„Å¶„Éï„Ç°„Ç§„É´„Å´‰øùÂ≠ò ---
      - name: Get PR diff
        id: diff
        run: |
          git fetch origin main
          git diff origin/main > pr_diff.txt
          echo "Diff file generated: $(wc -l pr_diff.txt | awk '{print $1}') lines"

      # --- Gemini CLI „ÅßÂ∑ÆÂàÜ„Çí„É¨„Éì„É•„Éº ---
      - name: Run Gemini CLI review with diff
        id: gemini
        uses: google-github-actions/run-gemini-cli@v0
        with:
          gemini_api_key: ${{ secrets.GEMINI_API_KEY }}
          prompt: |
            You are a strict Python code reviewer.
            Analyze the following pull request diff and provide constructive review comments:
            - Identify bugs, logic errors, and poor naming.
            - Suggest better structure and type hints.
            - Always return at least one comment, even if minor.
            - Respond in markdown.
            Here is the code diff:
            ```diff
            ${{ steps.diff.outputs.diff_content }}
            ```
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}

      # --- ReviewÁµêÊûú„ÇíPR„Å´ÊäïÁ®ø ---
      - name: Post Gemini review to PR
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const body = fs.readFileSync('gemini-artifacts/stdout.log', 'utf8');
            if (body.trim().length === 0) {
              console.log("No Gemini output to comment.");
              return;
            }
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.payload.pull_request.number,
              body: `### üß† Gemini AI Review\n\n${body}`
            });
